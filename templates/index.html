{% extends "base.html" %}

{% block style %}
<style type="text/css">
    .malware-search {
        display: flex;
        flex: auto;
        width: 100vw;
        /* height: inherit; */
        overflow-y: scroll;
        overflow-x: hide;
        /* grid: auto-flow / 50% 50%;
        grid-column-gap: 10px; */
    }
    .malware-search * {
        flex-grow: 1;
    }
    .malware-logo {
        height: 7vh;
        vertical-align: middle;
    }
    #ha {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    #ha-res {
        display: none;
        overflow-y: scroll;
        overflow-x: hide;
    }
    .sample-info {
        box-sizing: border-box;
        width: 100vw;
        padding-left: 2vw;
        margin-left: 10px;
        overflow: auto;
        overflow-x: hidden;
        word-wrap: break-word;
    }
    .sample-info > p {
        margin: 0px;
    }
    .sample-download {
        color: black!important;
    }
    @media (prefers-color-scheme: dark) {
        /* Overrides for Safari Dark Mode */
        .sample-download {
            color: white!important;
        }
    }
    .remove-icon {
        font-size: 15pt;
        color: red;
    }
    .download-icon {
        font-size: 15pt;
        color: Dodgerblue;
    }
</style>
{% endblock %}

{% block content %}

    <div>
        <br>
        <form method=POST enctype=multipart/form-data action="{{ url_for('upload') }}">
            Upload a malware sample:<br>
            <input type=file name=sample><br>
            <input type="submit">
        </form>
        <br>
    </div>
    <div class="malware-search">
        {% if 'VT' in available_malware_search %}
            <div id="vt">
                <h4>Search VirusTotal for samples!</h4>
                <p>Enter a query: <input id="vt-search" type="search"></p>
                <div id="vt-res"></div>
                <p>Powered by <img class="malware-logo" src="https://www.virustotal.com/gui/images/logo.svg" alt="VirusTotal"></p>
            </div>
        {% endif %}
        {% if 'HA' in available_malware_search %}
            <div id="ha">
                <h4>Search HybridAnalysis for samples!</h4>
                <p>Enter a query: <input id="ha-search" type="search"></p>
                <div id="ha-res"></div>
                <p>Powered by <img class="malware-logo" src="https://www.hybrid-analysis.com/img/logo.svg" alt="HybridAnalysis"></p>
            </div>
        {% endif %}
        {% if not 'VT' in available_malware_search and not 'HA' in available_malware_search %}
            <div id="unavailable">
                <h4>Searching functionality is currently unavailable!</h4>
                <p>Please register for an account with either VirusTotal or HybridAnalysis and reconfigure the website with the necessary API keys!</p>
            </div>
        {% endif %}
    </div>
    {% if samples %}
    <div>
        <h4>Samples Currently Being Processed:</h4>
        <ol id="samples-listing">
            {% for sample in samples %}
            <li>
                "<span class="sample-filename">{{ sample.filename }}</span>" - <em>Added at <span class="sample-time">{{ sample.time }}</span> on <span class="sample-date">{{ sample.date }}</span></em>
                 <span class="sample-remove remove-icon" onclick="removeSample('{{ sample.filename }}')"><i class="far fa-window-close"></i></span>
                <!-- <a href="{{ url_for('vt.vt_file_scan') }}" -->
            </li>
            {% endfor %}
        </ol>
    </div>
    <div>
        <form method="post" action="{{ url_for('start_processing') }}">
            <button id="malware-button" name="malware-button" type="submit" formmethod="post" style="color: red">
                The Malware Button
            </button>
        </form>
    </div>
    {% endif %}
{% endblock %}

{% block socketio %}
    {% if 'VT' in available_malware_search %}
        socket.on('vt-search-data', function(msg) {
            clearDiv.apply(['vt-res']);
            console.log(msg['data']['results']);
            msg['data']['results'].forEach(element => {
                $('#vt-res').append("<p>" + element['name'] + ": " + "<em>" + element['hash'] + "</em>" + "</p>")
            });
            return false;
        })

        var thread = null;
        function searchVT(t) {
            if (t.replace(/ /g,'') != "") {
                socket.emit('vt-search', {data: "vt-search", query: t});
            } else {
                $('#vt-res').empty();
            }
        }
        $('#vt-search').keyup(function() {
            clearTimeout(thread);
            var $this = $(this); thread = setTimeout(function(){searchVT($this.val())}, 350);
        });
    {% endif %}
    {% if 'HA' in available_malware_search %}
        socket.on('ha-search-data', function(msg) {
            clearDiv.apply(['ha-res']);
            console.log(msg['data']['results']);
            msg['data']['results'].forEach(element => {
            $('#ha-res').append("<div class='sample-info'><p>" + element['submit_name'] + " <span class='download-icon'><i onclick=\"downloadSample\('" + element['sha256'] + "'\)\" class='fas fa-file-download'></i></span></p></div>")
            });
            return false;
        })

        socket.on('ha-empty', function() {
            clearDiv.apply(['ha-res']);
            console.log('Cleared results!');
        })

        socket.on('reload', function() {
            location.reload();
        })

        var thread = null;
        function searchHA(t) {
            if (t.replace(/ /g,'') != "") {
                socket.emit('ha-search', {data: "ha-search", query: t});
                $('#ha-res').css('display','unset');
            } else {
                $('#ha-res').empty();
                $('#ha-res').css('display','blank');
            }
        }
        $('#ha-search').keyup(function() {
            clearTimeout(thread);
            var $this = $(this); thread = setTimeout(function(){searchHA($this.val())}, 350);
        });
        function downloadSample(t) {
            console.log('Downloading sample \"' + t + '\"!');
            socket.emit('ha-download', {data: "ha-download", hash: t})
        }
    {% endif %}
    function removeSample(t) {
        console.log('Removing sample \'' + t + '\' from the Queue!');
        socket.emit('samples-remove', {data: "samples-remove", sample: t});
        $(this).parent().remove();
    }
{% endblock %}
