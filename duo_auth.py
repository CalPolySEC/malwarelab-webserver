from flask import render_template, redirect, url_for, session, request, flash, Blueprint, current_app, g
import os
import duo_web

duo_auth = Blueprint('duo_auth', __name__, url_prefix='/auth/duo')

duo = {'ikey': None, 'skey': None, 'akey': None, 'host': None}

def init_duo():
    duo['ikey'] = os.environ.get('DUO_IKEY', None)
    duo['skey'] = os.environ.get('DUO_SKEY', None)
    duo['akey'] = os.environ.get('DUO_AKEY', None)
    duo['host'] = os.environ.get('DUO_HOST', None)

    return duo

def get_duo():
    if 'duo' not in g:
        g.duo = init_duo()

    return g.duo

@duo_auth.route('/login', methods=['GET', 'POST'])
def login():
    result = get_duo()
    print('DUO: {}'.format(result))
    print(session['user'])
    
    sig_request = duo_web.sign_request(result['ikey'], result['skey'], result['akey'], session['user'])
    print('sig_request: {}'.format(sig_request))
    if request.method == 'GET':
        return render_template('duoframe.html', duohost=result['host'], sig_request=sig_request)
    elif request.method == 'POST':
        user = duo_web.verify_response(result['ikey'], result['skey'], result['akey'], request.args.get('sig_response'))
        print('AUTH: {}'.format(user))
        if user == session['user']:
            return render_template(url_for('duo_auth.login'), user=user)

@duo_auth.route('/success', methods=['POST'])
def success():
    session['duo_logged_in'] = True
    url = session.get('X-Redirect-To', 'index')
    session.pop('X-Redirect-To')
    return redirect(url_for(url))
